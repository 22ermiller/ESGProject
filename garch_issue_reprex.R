library(xts)
library(rugarch)

times <- seq(from = as.Date("1990-03-01"), 
              to = as.Date("2024-09-01"), 
              by = "months")

transformed_rates <- c(0.0808000000, 0.0805000000, 0.0819000000, 0.0794000000, 0.0800000000,
            0.0767000000, 0.0764000000, 0.0737000000, 0.0728000000, 0.0728000000,
            0.0666000000, 0.0617000000, 0.0627000000, 0.0594000000, 0.0571000000,
            0.0579000000, 0.0576000000, 0.0572000000, 0.0551000000, 0.0525000000,
            0.0489000000, 0.0451000000, 0.0396000000, 0.0396000000, 0.0414000000,
            0.0411000000, 0.0372000000, 0.0382000000, 0.0363000000, 0.0325000000,
            0.0322000000, 0.0267000000, 0.0308000000, 0.0340000000, 0.0319000000,
            0.0301000000, 0.0303000000, 0.0296000000, 0.0293000000, 0.0314000000,
            0.0306000000, 0.0317000000, 0.0308000000, 0.0298000000, 0.0318000000,
            0.0319000000, 0.0316000000, 0.0310000000, 0.0358000000, 0.0382000000,
            0.0410000000, 0.0428000000, 0.0432000000, 0.0445000000, 0.0467000000,
            0.0505000000, 0.0522000000, 0.0571000000, 0.0595000000, 0.0607000000,
            0.0594000000, 0.0594000000, 0.0591000000, 0.0567000000, 0.0568000000,
            0.0561000000, 0.0545000000, 0.0553000000, 0.0548000000, 0.0545000000,
            0.0520000000, 0.0503000000, 0.0498000000, 0.0520000000, 0.0511000000,
            0.0523000000, 0.0527000000, 0.0525000000, 0.0532000000, 0.0510000000,
            0.0517000000, 0.0508000000, 0.0519000000, 0.0512000000, 0.0524000000,
            0.0532000000, 0.0524000000, 0.0507000000, 0.0518000000, 0.0528000000,
            0.0521000000, 0.0510000000, 0.0526000000, 0.0527000000, 0.0532000000,
            0.0526000000, 0.0526000000, 0.0512000000, 0.0502000000, 0.0508000000,
            0.0509000000, 0.0513000000, 0.0492000000, 0.0423000000, 0.0454000000,
            0.0449000000, 0.0449000000, 0.0453000000, 0.0471000000, 0.0444000000,
            0.0462000000, 0.0477000000, 0.0468000000, 0.0485000000, 0.0497000000,
            0.0488000000, 0.0516000000, 0.0527000000, 0.0548000000, 0.0571000000,
            0.0576000000, 0.0587000000, 0.0600000000, 0.0574000000, 0.0600000000,
            0.0625000000, 0.0627000000, 0.0627000000, 0.0637000000, 0.0623000000,
            0.0587000000, 0.0500000000, 0.0484000000, 0.0422000000, 0.0392000000,
            0.0367000000, 0.0367000000, 0.0353000000, 0.0344000000, 0.0237000000,
            0.0206000000, 0.0178000000, 0.0174000000, 0.0176000000, 0.0177000000,
            0.0179000000, 0.0177000000, 0.0177000000, 0.0172000000, 0.0168000000,
            0.0164000000, 0.0159000000, 0.0143000000, 0.0124000000, 0.0122000000,
            0.0118000000, 0.0120000000, 0.0112000000, 0.0110000000, 0.0114000000,
            0.0089000000, 0.0095000000, 0.0098000000, 0.0095000000, 0.0096000000,
            0.0095000000, 0.0093000000, 0.0094000000, 0.0097000000, 0.0093000000,
            0.0100000000, 0.0117000000, 0.0122000000, 0.0150000000, 0.0158000000,
            0.0171000000, 0.0199000000, 0.0222000000, 0.0232000000, 0.0251000000,
            0.0275000000, 0.0280000000, 0.0293000000, 0.0297000000, 0.0317000000,
            0.0348000000, 0.0348000000, 0.0361000000, 0.0396000000, 0.0397000000,
            0.0416000000, 0.0447000000, 0.0460000000, 0.0467000000, 0.0482000000,
            0.0483000000, 0.0508000000, 0.0512000000, 0.0502000000, 0.0488000000,
            0.0507000000, 0.0503000000, 0.0507000000, 0.0513000000, 0.0515000000,
            0.0504000000, 0.0490000000, 0.0479000000, 0.0495000000, 0.0489000000,
            0.0447000000, 0.0392000000, 0.0381000000, 0.0306000000, 0.0326000000,
            0.0210000000, 0.0170000000, 0.0140000000, 0.0145000000, 0.0185000000,
            0.0187000000, 0.0166000000, 0.0172000000, 0.0085000000, 0.0048989865,
            -0.0048305643, -0.0041629073, 0.0019190693, 0.0021009075, 0.0008950972,
            -0.0006971714, -0.0017353682, -0.0003940483, 0.0001620799, -0.0013648284,
            -0.0030471896, -0.0056013177, -0.0056013177, -0.0041629073, -0.0030471896,
            -0.0017353682, -0.0006971714, -0.0003940483, -0.0006971714, -0.0003940483,
            -0.0006971714, -0.0017353682, -0.0006971714, -0.0017353682, -0.0006971714,
            -0.0010198640, -0.0010198640, -0.0013648284, -0.0048305643, -0.0065129255,
            -0.0065129255, -0.0110943791, -0.0030471896, -0.0110943791, -0.0110943791,
            -0.0145601150, -0.0145601150, -0.0110943791, -0.0056013177, -0.0041629073,
            -0.0041629073, -0.0035739921, -0.0048305643, -0.0030471896, -0.0030471896,
            -0.0030471896, -0.0035739921, -0.0035739921, -0.0030471896, -0.0041629073,
            -0.0056013177, -0.0025706387, -0.0041629073, -0.0056013177, -0.0065129255,
            -0.0076286432, -0.0076286432, -0.0110943791, -0.0110943791, -0.0076286432,
            -0.0065129255, -0.0048305643, -0.0065129255, -0.0065129255, -0.0076286432,
            -0.0090670536, -0.0076286432, -0.0110943791, -0.0090670536, -0.0090670536,
            -0.0110943791, -0.0110943791, -0.0090670536, -0.0110943791, -0.0110943791,
            -0.0110943791, -0.0090670536, -0.0145601150, -0.0110943791, -0.0145601150,
            -0.0041629073, -0.0090670536, -0.0145601150, -0.0041629073, 0.0006624972,
            0.0008950972, 0.0032166253, 0.0029224228, 0.0011173561, 0.0008950972,
            0.0024458719, 0.0021009075, 0.0022763641, 0.0029224228, 0.0027685645,
            0.0032166253, 0.0047958900, 0.0053000000, 0.0051000000, 0.0063000000,
            0.0079000000, 0.0083000000, 0.0098000000, 0.0106000000, 0.0108000000,
            0.0102000000, 0.0101000000, 0.0118000000, 0.0127000000, 0.0144000000,
            0.0148000000, 0.0163000000, 0.0177000000, 0.0185000000, 0.0192000000,
            0.0198000000, 0.0203000000, 0.0213000000, 0.0223000000, 0.0232000000,
            0.0238000000, 0.0242000000, 0.0240000000, 0.0244000000, 0.0243000000,
            0.0243000000, 0.0235000000, 0.0221000000, 0.0207000000, 0.0198000000,
            0.0182000000, 0.0152000000, 0.0160000000, 0.0154000000, 0.0157000000,
            0.0113000000, -0.0035739921, -0.0021355818, -0.0013648284, -0.0013648284,
            -0.0030471896, -0.0021355818, -0.0035739921, -0.0035739921, -0.0035739921,
            -0.0035739921, -0.0048305643, -0.0065129255, -0.0110943791, -0.0076286432,
            -0.0110943791, -0.0065129255, -0.0065129255, -0.0065129255, -0.0076286432,
            -0.0065129255, -0.0056013177, -0.0041629073, 0.0001620799, 0.0027685645,
            0.0053000000, 0.0090000000, 0.0115000000, 0.0173000000, 0.0256000000,
            0.0297000000, 0.0346000000, 0.0423000000, 0.0433000000, 0.0453000000,
            0.0466000000, 0.0490000000, 0.0490000000, 0.0527000000, 0.0550000000,
            0.0544000000, 0.0554000000, 0.0553000000, 0.0562000000, 0.0557000000,
            0.0543000000, 0.0546000000, 0.0542000000, 0.0542000000, 0.0544000000,
            0.0546000000, 0.0552000000, 0.0547000000, 0.0537000000, 0.0519000000)

# plot interest rates
plot(transformed_rates, type = "l", xlab = "Time", ylab = "Interest Rate", main = "Interest Rates Over Time")
# empirical average
mean(transformed_rates)

# Create an xts object
data_xts <- xts(transformed_rates, order.by = times)

# cut out the first 10 values
data_xts2 <- data_xts[-(1:10)]

# cut out the first 50 values
data_xts3 <- data_xts[-(1:50)]

# Fit a GARCH model
garch_spec <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
                                mean.model = list(armaOrder = c(1, 1)
                                ),
                                distribution.model = "norm")

# fit models to different data sets
garch_fit <- ugarchfit(spec = garch_spec, data = data_xts)
garch_fit2 <- ugarchfit(spec = garch_spec, data = data_xts2)
garch_fit3 <- ugarchfit(spec = garch_spec, data = data_xts3)

# Compare mu and starting value
coef(garch_fit)["mu"]
data_xts[1,1]

coef(garch_fit2)["mu"]
data_xts2[1,1]

coef(garch_fit3)["mu"]
data_xts3[1,1]

# Simulation --------------------------------------------------------------

multiple_interest_simulation <- function(n_sims = 1000, sim_length = 80*12) {
  
  garch_sims <- matrix(NA, nrow = n_sims, ncol = sim_length)
  garch_sims2 <- matrix(NA, nrow = n_sims, ncol = sim_length)
  garch_sims3 <- matrix(NA, nrow = n_sims, ncol = sim_length)
  
  for(i in 1:n_sims){
    garch_sims[i,] <- ugarchsim(garch_fit, n.sim = sim_length, startMethod = "sample")@simulation$seriesSim
    garch_sims2[i,] <- ugarchsim(garch_fit2, n.sim = sim_length, startMethod = "sample")@simulation$seriesSim
    garch_sims3[i,] <- ugarchsim(garch_fit3, n.sim = sim_length, startMethod = "sample")@simulation$seriesSim
    
  }
  
  garch_avg <- colMeans(garch_sims)
  garch_avg2 <- colMeans(garch_sims2)
  garch_avg3 <- colMeans(garch_sims3)
  
  garch_ci <- apply(garch_sims, 2, quantile, probs = c(.025, .975))
  garch_ci2 <- apply(garch_sims2, 2, quantile, probs = c(.025, .975))
  garch_ci3 <- apply(garch_sims3, 2, quantile, probs = c(.025, .975))
  
  upper_bound <- max(c(garch_ci[2,], garch_ci2[2,], garch_ci3[2,]))
  lower_bound <- min(c(garch_ci[1,], garch_ci2[1,], garch_ci3[1,]))
  
  # plot simulation
  par(mfrow = c(2, 2))
  plot(garch_avg, type = "l", ylim = c(lower_bound, upper_bound), main = "DF 1 Simulation")
  lines(garch_ci[2,], col = "red", lty = 2)
  lines(garch_ci[1,], col = "red", lty = 2)
  abline(h = coef(garch_fit)["mu"], col = "blue", lty = 2)
  abline(h = mean(data_xts), col = "brown", lty = 3)
  
  plot(garch_avg2, type = "l", ylim = c(lower_bound, upper_bound), main = "DF 2 Simulation")
  lines(garch_ci2[2,], col = "red", lty = 2)
  lines(garch_ci2[1,], col = "red", lty = 2)
  abline(h = coef(garch_fit2)["mu"], col = "blue", lty = 2)
  abline(h = mean(data_xts2), col = "brown", lty = 3)
  
  plot(garch_avg3, type = "l", ylim = c(lower_bound, upper_bound), main = "DF 3 Simulation")
  lines(garch_ci3[2,], col = "red", lty = 2)
  lines(garch_ci3[1,], col = "red", lty = 2)
  abline(h = coef(garch_fit3)["mu"], col = "blue", lty = 2)
  abline(h = mean(data_xts3), col = "brown", lty = 3)
  
}

# simulate 
# blue dash is fitted mu value
# green dash is empirical mean
# solid black is average of simulation
multiple_interest_simulation()


